import requests, re, pyasn
import matplotlib.pyplot as plt
from bs4 import BeautifulSoup
from charts.chart import Chart
asndb = pyasn.pyasn('ipasn_db')
class ASNSizeChart(Chart):

    def asn_size(self, asn):
        return sum([2**(32-int(x.split('/')[-1])) for x in asndb.get_as_prefixes(int(asn))])

    def show(self, data, show=True):
        print('ASN Size')
        asns = [x[-6] for x in data if x[-6] != '-' and x[-6] != '' and asndb.get_as_prefixes(x[-6])]
        results = {asn:(asns.count(asn)*100/self.asn_size(asn)) for asn in asns}

        results = {k: results[k] for k in sorted(results.keys(), key=lambda x: results[x])[-10:]}

        plt.bar(range(0,len(results)), results.values())
        plt.xlabel('ASN')
        plt.ylabel('% of malware domains')
        plt.title('% of malware domains weighted by ASN IP space')
        plt.xticks(range(0, len(results)), results.keys())
        if show:
            plt.show()
        else:
            plt.savefig('charts/results/asn_per_size.png')
        plt.close()
